<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QQQ LEAPS | 控制终端 v2.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fallback CDN for Chinese users (75cdn mirrors Google Fonts) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    <!-- Backup CDN -->
    <link href="https://cdn.jsdelivr.net/gh/googlefonts/noto-cjk@main/Sans/Variable/NotoSansCJK-VF.ttf" rel="preload" as="font" type="font/ttf" crossorigin>

    <style>
        :root {
            --neon-cyan: #00f0ff;
            --electric-orange: #ff6b00;
            --matrix-green: #00ff41;
            --crimson-red: #dc143c;
            --bg-deep: #0a0a0a;
            --bg-card: #111111;
            --bg-input: #0f0f0f;
            --border-dim: #333333;
        }

        body {
            background-color: var(--bg-deep);
            color: #e5e5e5;
            /* Extended fallback stack for Chinese users */
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', 'Monaco', 'Courier New', 'Liberation Mono', 'Microsoft YaHei UI', monospace;
            font-display: swap;
            overflow-x: hidden;
        }

        h1, h2, h3, .header-font {
            /* Extended fallback stack preserving industrial look */
            font-family: 'Rajdhani', 'Impact', 'Arial Black', 'Oswald', 'Noto Sans SC', system-ui, -apple-system, sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-display: swap;
        }

        /* Background Grid Pattern */
        .grid-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(51, 51, 51, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(51, 51, 51, 0.1) 1px, transparent 1px);
            background-size: 40px 40px;
            z-index: -2;
            pointer-events: none;
        }

        /* Scanline Effect */
        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                rgba(18, 16, 16, 0) 50%,
                rgba(0, 0, 0, 0.1) 50%
            ), linear-gradient(
                90deg,
                rgba(255, 0, 0, 0.03),
                rgba(0, 255, 0, 0.01),
                rgba(0, 0, 255, 0.03)
            );
            background-size: 100% 4px, 3px 100%;
            z-index: -1;
            pointer-events: none;
            opacity: 0.3;
        }

        /* Grain Texture */
        .grain {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            opacity: 0.05;
            z-index: -1;
            pointer-events: none;
        }

        .brutalist-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-dim);
            position: relative;
            transition: all 0.3s ease;
        }

        .brutalist-card::before {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            width: 10px;
            height: 10px;
            border-top: 2px solid var(--neon-cyan);
            border-left: 2px solid var(--neon-cyan);
        }

        .brutalist-card.accent-orange::before {
            border-top-color: var(--electric-orange);
            border-left-color: var(--electric-orange);
        }

        .brutalist-card.accent-green::before {
            border-top-color: var(--matrix-green);
            border-left-color: var(--matrix-green);
        }

        .brutalist-input {
            border: 1px solid var(--border-dim);
            background-color: var(--bg-input);
            color: white;
            padding: 0.5rem;
            width: 100%;
            outline: none;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', 'Monaco', 'Courier New', monospace;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .brutalist-input:focus {
            border-color: var(--neon-cyan);
            box-shadow: 0 0 10px rgba(0, 240, 255, 0.2);
        }

        .brutalist-button {
            background-color: transparent;
            border: 1px solid var(--neon-cyan);
            color: var(--neon-cyan);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .brutalist-button:hover {
            background-color: var(--neon-cyan);
            color: black;
            box-shadow: 0 0 15px var(--neon-cyan);
        }

        .brutalist-button:active {
            transform: scale(0.98);
        }

        .brutalist-button.btn-green {
            border-color: var(--matrix-green);
            color: var(--matrix-green);
        }

        .brutalist-button.btn-green:hover {
            background-color: var(--matrix-green);
            color: black;
            box-shadow: 0 0 15px var(--matrix-green);
        }

        .brutalist-button.btn-orange {
            border-color: var(--electric-orange);
            color: var(--electric-orange);
        }

        .brutalist-button.btn-orange:hover {
            background-color: var(--electric-orange);
            color: black;
            box-shadow: 0 0 15px var(--electric-orange);
        }

        /* Custom Table Styling */
        table {
            border-collapse: separate;
            border-spacing: 0;
        }

        th {
            font-family: 'Rajdhani', 'Impact', 'Arial Black', 'Oswald', system-ui, sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #888;
            border-bottom: 1px solid var(--border-dim);
        }

        td {
            border-bottom: 1px solid rgba(51, 51, 51, 0.5);
        }

        tr:hover td {
            background-color: rgba(255, 255, 255, 0.03);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .staggered-reveal > * {
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
        }

        .staggered-reveal > *:nth-child(1) { animation-delay: 0.1s; }
        .staggered-reveal > *:nth-child(2) { animation-delay: 0.2s; }
        .staggered-reveal > *:nth-child(3) { animation-delay: 0.3s; }
        .staggered-reveal > *:nth-child(4) { animation-delay: 0.4s; }
        .staggered-reveal > *:nth-child(5) { animation-delay: 0.5s; }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        .pulse-status {
            animation: pulse 2s infinite ease-in-out;
        }

        /* Angled Corners with clip-path */
        .angle-top-right {
            clip-path: polygon(0 0, calc(100% - 15px) 0, 100% 15px, 100% 100%, 0 100%);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-deep); }
        ::-webkit-scrollbar-thumb { background: var(--border-dim); }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>

    <script>
        let currentMaxHoldDays = 270;

        async function fetchStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();

                // Connection Status
                const connDot = document.getElementById('conn-dot');
                const connText = document.getElementById('conn-text');
                if (data.connected) {
                    connDot.classList.remove('bg-[#dc143c]');
                    connDot.classList.add('bg-[#00ff41]');
                    connText.innerText = '已连接';
                    connText.classList.add('text-[#00ff41]');
                    connText.classList.remove('text-[#dc143c]');
                } else {
                    connDot.classList.remove('bg-[#00ff41]');
                    connDot.classList.add('bg-[#dc143c]');
                    connText.innerText = '离线';
                    connText.classList.add('text-[#dc143c]');
                    connText.classList.remove('text-[#00ff41]');
                }

                // Positions Table
                const tbody = document.getElementById('pos-body');
                tbody.innerHTML = '';
                if (!data.positions || data.positions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-gray-600 italic uppercase tracking-widest">暂无活跃持仓</td></tr>';
                } else {
                    data.positions.forEach(pos => {
                        const tr = document.createElement('tr');
                        tr.className = "group";
                        tr.innerHTML = `
                            <td class="p-4 font-bold text-[#00f0ff]">${pos.symbol}</td>
                            <td class="p-4 text-xs font-mono text-gray-400">${pos.contract_id}</td>
                            <td class="p-4 text-xs text-gray-500">${pos.entry_date}</td>
                            <td class="p-4 font-mono">$${pos.entry_price.toFixed(2)}</td>
                            <td class="p-4 font-mono">${pos.quantity}</td>
                            <td class="p-4 font-mono text-gray-600">--</td> 
                            <td class="p-4"><span class="border border-[#00ff41] text-[#00ff41] px-2 py-0.5 text-[10px] font-bold uppercase">持仓中</span></td>
                        `;
                        tbody.appendChild(tr);
                    });
                }

                // Fill Buy Settings
                if (data.settings && data.settings.entry_drop_pct !== undefined && !document.forms['buy-form'].dataset.filled) {
                    const bf = document.forms['buy-form'];
                    bf.entry_drop_pct.value = (data.settings.entry_drop_pct * 100).toFixed(2);
                    bf.roll_drop_pct.value = (data.settings.roll_drop_pct * 100).toFixed(2);
                    bf.target_delta.value = data.settings.target_delta;
                    bf.min_expiry_days.value = data.settings.min_expiry_days;
                    bf.max_positions.value = data.settings.max_positions;
                    bf.dataset.filled = "true";
                }

                // Fill Profit Settings
                if (data.settings && data.settings.auto_invest_min_threshold !== undefined && !document.forms['profit-form'].dataset.filled) {
                    const pf = document.forms['profit-form'];
                    pf.auto_invest_qqqm.value = data.settings.auto_invest_qqqm;
                    pf.auto_invest_min_threshold.value = data.settings.auto_invest_min_threshold;
                    pf.dataset.filled = "true";
                }

                if (data.stats) {
                    const profit = data.stats.leaps_realized_profit || 0;
                    const invested = data.stats.qqqm_invested_capital || 0;
                    const available = profit - invested;
                    document.getElementById('profit-pool').innerText = `$${available.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    document.getElementById('invested-info').innerText = `已投: $${invested.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} / 总计: $${profit.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                }

                // Fill Account Summary
                if (data.portfolio && data.portfolio.summary) {
                    const sum = data.portfolio.summary;
                    document.getElementById('net-liq').innerText = '$' + sum.NetLiquidity.toLocaleString(undefined, { minimumFractionDigits: 2 });
                    document.getElementById('cash-balance').innerText = '$' + sum.TotalCashValue.toLocaleString(undefined, { minimumFractionDigits: 2 });
                    document.getElementById('buying-power').innerText = '$' + sum.BuyingPower.toLocaleString(undefined, { minimumFractionDigits: 2 });
                }

                // Portfolio Table
                const pbody = document.getElementById('portfolio-body');
                if (pbody && data.portfolio && data.portfolio.holdings) {
                    pbody.innerHTML = '';
                    data.portfolio.holdings.forEach(h => {
                        const tr = document.createElement('tr');
                        tr.className = "text-[11px] group";
                        const pnlColor = h.unrealizedPnL >= 0 ? 'text-[#00ff41]' : 'text-[#dc143c]';
                        tr.innerHTML = `
                            <td class="p-3 font-bold text-gray-200">${h.symbol}</td>
                            <td class="p-3 text-gray-500 uppercase">${h.secType}</td>
                            <td class="p-3 font-mono">${h.quantity}</td>
                            <td class="p-3 font-mono text-gray-400">$${h.mktPrice.toFixed(2)}</td>
                            <td class="p-3 font-bold ${pnlColor}">$${h.unrealizedPnL.toFixed(2)}</td>
                            <td class="p-3 text-gray-500 font-mono text-right">$${h.mktValue.toLocaleString()}</td>
                        `;
                        pbody.appendChild(tr);
                    });
                }

                // Fill Sell Settings
                if (data.settings && data.settings.time_exit_days !== undefined && !document.forms['sell-form'].dataset.filled) {
                    const sf = document.forms['sell-form'];
                    sf.time_exit_days.value = data.settings.time_exit_days;
                    currentMaxHoldDays = data.settings.time_exit_days;
                    updateExitTiersDisplay(); // Sync tiers display
                    sf.dataset.filled = "true";
                }

            } catch (e) { console.error(e); }
        }

        async function fetchExitTiers() {
            try {
                const res = await fetch('/api/exit_tiers');
                const data = await res.json();
                renderTiers(data.tiers);
            } catch (e) { console.error(e); }
        }

        function renderTiers(tiers) {
            const tbody = document.getElementById('tiers-body');
            tbody.innerHTML = '';

            tiers.forEach((tier, idx) => {
                const isLast = idx === tiers.length - 1;
                const tr = document.createElement('tr');
                tr.className = "tier-row";
                tr.innerHTML = `
                    <td class="p-3">
                        <div class="flex items-center space-x-2">
                            <input type="number" class="tier-min brutalist-input w-20 text-center" value="${tier.days_min}">
                            <span class="text-gray-600">/</span>
                            <input type="number" class="tier-max brutalist-input w-20 text-center" 
                                   value="${isLast ? currentMaxHoldDays : tier.days_max}" ${isLast ? 'disabled' : ''}>
                        </div>
                    </td>
                    <td class="p-3">
                        <div class="flex items-center space-x-2">
                            <input type="number" class="tier-pnl brutalist-input w-20 text-center text-[#00ff41] font-bold" value="${(tier.target_pnl * 100).toFixed(0)}">
                            <span class="text-[10px] text-gray-500 uppercase font-bold">%</span>
                        </div>
                    </td>
                    <td class="p-3 text-right">
                        <button onclick="removeTierRow(this)" class="text-[#dc143c] hover:text-white transition-colors text-xl leading-none">&times;</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            updateExitTiersDisplay();
        }

        function addTierRow() {
            const tbody = document.getElementById('tiers-body');
            const rows = tbody.querySelectorAll('.tier-row');
            let lastMax = 0;
            if (rows.length > 0) {
                // Update previous last row to be editable if it's not the last anymore
                const prevLastMax = rows[rows.length - 1].querySelector('.tier-max');
                prevLastMax.disabled = false;
                lastMax = parseInt(prevLastMax.value) || 0;
            }

            const tr = document.createElement('tr');
            tr.className = "tier-row";
            tr.innerHTML = `
                <td class="p-3">
                    <div class="flex items-center space-x-2">
                        <input type="number" class="tier-min brutalist-input w-20 text-center" value="${lastMax + 1}">
                        <span class="text-gray-600">/</span>
                        <input type="number" class="tier-max brutalist-input w-20 text-center" value="${currentMaxHoldDays}" disabled>
                    </div>
                </td>
                <td class="p-3">
                    <div class="flex items-center space-x-2">
                        <input type="number" class="tier-pnl brutalist-input w-20 text-center text-[#00ff41] font-bold" value="10">
                        <span class="text-[10px] text-gray-500 uppercase font-bold">%</span>
                    </div>
                </td>
                <td class="p-3 text-right">
                    <button onclick="removeTierRow(this)" class="text-[#dc143c] hover:text-white transition-colors text-xl leading-none">&times;</button>
                </td>
            `;
            tbody.appendChild(tr);
            updateExitTiersDisplay();
        }

        function removeTierRow(btn) {
            btn.closest('tr').remove();
            const rows = document.querySelectorAll('.tier-row');
            if (rows.length > 0) {
                const lastIdx = rows.length - 1;
                const lastMax = rows[lastIdx].querySelector('.tier-max');
                lastMax.value = currentMaxHoldDays;
                lastMax.disabled = true;
            }
        }

        function updateExitTiersDisplay() {
            const rows = document.querySelectorAll('.tier-row');
            rows.forEach((row, idx) => {
                const min = parseInt(row.querySelector('.tier-min').value);
                const isLast = idx === rows.length - 1;

                if (isLast) {
                    row.querySelector('.tier-max').value = currentMaxHoldDays;
                }

                if (min >= currentMaxHoldDays) {
                    row.classList.add('opacity-20', 'grayscale');
                    row.title = "最小天数超过了强制平仓限制";
                } else {
                    row.classList.remove('opacity-20', 'grayscale');
                    row.title = "";
                }
            });
        }

        async function saveExitTiers() {
            const rows = document.querySelectorAll('.tier-row');
            const tiers = [];
            rows.forEach(row => {
                const min = parseInt(row.querySelector('.tier-min').value);
                const max = row.querySelector('.tier-max').disabled ? currentMaxHoldDays : parseInt(row.querySelector('.tier-max').value);
                const pnl = parseFloat(row.querySelector('.tier-pnl').value) / 100;

                if (min < currentMaxHoldDays) {
                    tiers.push({ days_min: min, days_max: max, target_pnl: pnl });
                }
            });

            const btn = document.getElementById('save-tiers-btn');
            const originalText = '保存梯度';
            btn.innerText = '上传中...';

            const res = await fetch('/api/exit_tiers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tiers })
            });

            if (res.ok) {
                btn.innerText = '已保存';
                setTimeout(() => btn.innerText = originalText, 2000);
            } else {
                btn.innerText = '传输错误';
                setTimeout(() => btn.innerText = originalText, 2000);
            }
        }

        async function saveBuySettings(e) {
            e.preventDefault();
            const form = new FormData(e.target);
            const data = Object.fromEntries(form.entries());
            if (data.entry_drop_pct) data.entry_drop_pct = parseFloat(data.entry_drop_pct) / 100;
            if (data.roll_drop_pct) data.roll_drop_pct = parseFloat(data.roll_drop_pct) / 100;
            if (data.target_delta) data.target_delta = parseFloat(data.target_delta);
            if (data.min_expiry_days) data.min_expiry_days = parseInt(data.min_expiry_days);
            if (data.max_positions) data.max_positions = parseInt(data.max_positions);

            const btn = document.getElementById('save-buy-btn');
            const originalText = '更新买入配置';
            btn.innerText = '执行中...';
            const res = await fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (res.ok) {
                btn.innerText = '已保存';
                setTimeout(() => btn.innerText = originalText, 2000);
            } else { 
                btn.innerText = '保存失败'; 
                setTimeout(() => btn.innerText = originalText, 2000);
            }
        }

        async function saveSellSettings(e) {
            e.preventDefault();
            const form = new FormData(e.target);
            const data = Object.fromEntries(form.entries());
            if (data.time_exit_days) {
                data.time_exit_days = parseInt(data.time_exit_days);
                currentMaxHoldDays = data.time_exit_days;
                updateExitTiersDisplay();
            }

            const btn = document.getElementById('save-sell-btn');
            const originalText = '更新卖出配置';
            btn.innerText = '执行中...';
            const res = await fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (res.ok) {
                btn.innerText = '已保存';
                setTimeout(() => btn.innerText = originalText, 2000);
            } else { 
                btn.innerText = '保存失败'; 
                setTimeout(() => btn.innerText = originalText, 2000);
            }
        }

        setInterval(fetchStatus, 3000);

        window.onload = function () {
            fetchStatus();
            fetchExitTiers();

            async function saveProfitSettings(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const settings = {
                    auto_invest_qqqm: parseInt(formData.get('auto_invest_qqqm')),
                    auto_invest_min_threshold: parseFloat(formData.get('auto_invest_min_threshold'))
                };

                const btn = document.getElementById('save-profit-btn');
                const originalText = '更新循环参数';
                btn.innerText = '写入中...';

                try {
                    const res = await fetch('/api/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(settings)
                    });
                    if (res.ok) {
                        btn.innerText = '已保存';
                        setTimeout(() => btn.innerText = originalText, 2000);
                        fetchStatus();
                    } else {
                        btn.innerText = 'IO 错误';
                        setTimeout(() => btn.innerText = originalText, 2000);
                    }
                } catch (err) {
                    btn.innerText = '超时错误';
                    setTimeout(() => btn.innerText = originalText, 2000);
                }
            }

            document.getElementById('buy-form').onsubmit = saveBuySettings;
            document.getElementById('sell-form').onsubmit = saveSellSettings;
            document.getElementById('profit-form').onsubmit = saveProfitSettings;

            // Re-sync tiers display if manual input changes
            document.forms['sell-form'].time_exit_days.addEventListener('input', (e) => {
                currentMaxHoldDays = parseInt(e.target.value) || 0;
                updateExitTiersDisplay();
            });
        };
    </script>
</head>

<body>
    <div class="grid-bg"></div>
    <div class="scanlines"></div>
    <div class="grain"></div>

    <!-- Top Navigation -->
    <nav class="border-b border-[#333] bg-[#0a0a0a]/80 backdrop-blur-md sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-6">
                <div class="bg-[#00f0ff] text-black px-3 py-1 font-bold angle-top-right text-lg">
                    QQQ LEAPS | 控制终端 v2.1
                </div>
                <div class="flex items-center space-x-3 border-l border-[#333] pl-6">
                    <div id="conn-dot" class="w-2.5 h-2.5 bg-[#dc143c] pulse-status"></div>
                    <span id="conn-text" class="text-[10px] font-bold tracking-[0.2em] text-[#dc143c]">离线</span>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <div class="hidden md:block text-[10px] text-gray-500 font-bold tracking-widest uppercase">
                    系统时间: <span id="sys-time" class="text-gray-400">00:00:00</span>
                </div>
                <form action="/logout" method="POST" class="m-0">
                    <button class="text-[10px] border border-[#333] px-4 py-1.5 hover:bg-[#dc143c] hover:border-[#dc143c] hover:text-white transition-all duration-300 font-bold uppercase tracking-widest">
                        终止会话
                    </button>
                </form>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-6 space-y-8 staggered-reveal">
        <!-- Summary Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="brutalist-card p-6">
                <div class="text-[10px] uppercase text-gray-500 font-bold mb-2 tracking-[0.15em]">资产净值</div>
                <div id="net-liq" class="text-2xl font-bold text-[#00f0ff] font-mono">$0.00</div>
                <div class="mt-2 h-0.5 bg-[#333] w-full relative">
                    <div class="absolute top-0 left-0 h-full bg-[#00f0ff] w-1/3 opacity-30"></div>
                </div>
            </div>
            <div class="brutalist-card accent-green p-6">
                <div class="text-[10px] uppercase text-gray-500 font-bold mb-2 tracking-[0.15em]">现金余额</div>
                <div id="cash-balance" class="text-2xl font-bold text-[#00ff41] font-mono">$0.00</div>
                <div class="mt-2 h-0.5 bg-[#333] w-full relative">
                    <div class="absolute top-0 left-0 h-full bg-[#00ff41] w-1/2 opacity-30"></div>
                </div>
            </div>
            <div class="brutalist-card p-6 border-l-4 border-l-[#a855f7]">
                <div class="text-[10px] uppercase text-gray-500 font-bold mb-2 tracking-[0.15em]">利润池 (可用)</div>
                <div id="profit-pool" class="text-2xl font-bold text-[#a855f7] font-mono">$0.00</div>
                <div id="invested-info" class="text-[9px] text-gray-600 mt-2 font-bold uppercase truncate tracking-tighter">已投: $0.00 / 总计: $0.00</div>
            </div>
            <div class="brutalist-card accent-orange p-6">
                <div class="text-[10px] uppercase text-gray-500 font-bold mb-2 tracking-[0.15em]">购买力</div>
                <div id="buying-power" class="text-2xl font-bold text-[#ff6b00] font-mono">$0.00</div>
                <div class="mt-2 h-0.5 bg-[#333] w-full relative">
                    <div class="absolute top-0 left-0 h-full bg-[#ff6b00] w-2/3 opacity-30"></div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Position Tables -->
            <div class="lg:col-span-2 space-y-8">
                <!-- LEAPS Strategy Positions -->
                <div class="brutalist-card border-l-0 overflow-hidden">
                    <div class="p-4 bg-[#1a1a1a] border-b border-[#333] flex justify-between items-center">
                        <h2 class="text-lg font-bold flex items-center">
                            <span class="w-1.5 h-1.5 bg-[#00f0ff] mr-3"></span>
                            LEAPS 核心策略
                        </h2>
                        <span class="text-[9px] font-bold text-gray-500 uppercase tracking-widest">实时追踪</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-[#0f0f0f]">
                                <tr>
                                    <th class="p-4">代码</th>
                                    <th class="p-4">合约 ID</th>
                                    <th class="p-4">开仓日期</th>
                                    <th class="p-4">开仓价</th>
                                    <th class="p-4">数量</th>
                                    <th class="p-4">未实现盈亏</th>
                                    <th class="p-4">状态</th>
                                </tr>
                            </thead>
                            <tbody id="pos-body" class="text-sm">
                                <!-- Data injected via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Portfolio Overview -->
                <div class="brutalist-card border-l-0 overflow-hidden">
                    <div class="p-4 bg-[#1a1a1a] border-b border-[#333] flex justify-between items-center">
                        <h2 class="text-lg font-bold flex items-center">
                            <span class="w-1.5 h-1.5 bg-[#ff6b00] mr-3"></span>
                            综合持仓
                        </h2>
                        <span class="text-[9px] font-bold text-gray-500 uppercase tracking-widest">全账户</span>
                    </div>
                    <div class="overflow-x-auto max-h-[400px]">
                        <table class="w-full text-left">
                            <thead class="bg-[#0f0f0f] sticky top-0 z-10">
                                <tr>
                                    <th class="p-4">代码</th>
                                    <th class="p-4">类型</th>
                                    <th class="p-4">数量</th>
                                    <th class="p-4">现价</th>
                                    <th class="p-4">浮盈</th>
                                    <th class="p-4 text-right">市值</th>
                                </tr>
                            </thead>
                            <tbody id="portfolio-body" class="text-sm">
                                <!-- Data injected via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right Column: Settings Panels -->
            <div class="space-y-8">
                <!-- Buy Protocol Settings -->
                <div class="brutalist-card p-6 border-l-4 border-l-[#00f0ff]">
                    <h2 class="text-xl font-bold mb-6 flex items-center border-b border-[#333] pb-2">
                        买入/ROLL 条件
                    </h2>
                    <form id="buy-form" class="space-y-5">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1.5 tracking-widest">入场跌幅 (%)</label>
                                <input name="entry_drop_pct" type="number" step="0.1" autocomplete="off" class="brutalist-input text-[#00f0ff]">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1.5 tracking-widest">ROLL 跌幅 (%)</label>
                                <input name="roll_drop_pct" type="number" step="0.1" autocomplete="off" class="brutalist-input text-[#a855f7]">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1.5 tracking-widest">目标 Delta</label>
                            <input name="target_delta" type="number" step="0.01" autocomplete="off" class="brutalist-input">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1.5 tracking-widest">最小到期天数</label>
                                <input name="min_expiry_days" type="number" autocomplete="off" class="brutalist-input">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1.5 tracking-widest">最大持仓</label>
                                <input name="max_positions" type="number" autocomplete="off" class="brutalist-input">
                            </div>
                        </div>

                        <p class="text-[9px] text-gray-600 font-bold uppercase leading-relaxed italic border-l-2 border-[#333] pl-3 py-1">
                            注：当达到最大持仓时，ROLL 协议将触发 FIFO（先进先出）平仓并立即替换。
                        </p>

                        <button id="save-buy-btn" type="submit" class="brutalist-button w-full mt-4">
                            更新买入配置
                        </button>
                    </form>
                </div>

                <!-- Sell & Tier Settings -->
                <div class="brutalist-card p-6 border-l-4 border-l-[#dc143c]">
                    <h2 class="text-xl font-bold mb-6 flex items-center border-b border-[#333] pb-2">
                        卖出条件
                    </h2>
                    <form id="sell-form" class="space-y-4 mb-8">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1.5 tracking-widest">强制平仓天数</label>
                            <input name="time_exit_days" type="number" autocomplete="off" class="brutalist-input border-[#dc143c]/50">
                            <p class="text-[9px] text-gray-600 mt-2 font-bold uppercase tracking-tighter">到达期限限制时将自动平仓。</p>
                        </div>
                        <button id="save-sell-btn" type="submit" class="brutalist-button btn-orange w-full">
                            更新卖出配置
                        </button>
                    </form>

                    <div class="space-y-4">
                        <div class="flex justify-between items-center border-b border-[#333] pb-2">
                            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">收益梯度</h3>
                            <button onclick="addTierRow()" class="text-[10px] bg-[#333] hover:bg-[#444] text-white px-3 py-1 font-bold uppercase tracking-widest transition-colors">
                                + 添加梯度
                            </button>
                        </div>
                        <table class="w-full text-xs">
                            <thead>
                                <tr class="text-left">
                                    <th class="p-2 pl-0">天数范围</th>
                                    <th class="p-2">目标盈亏 %</th>
                                    <th class="p-2"></th>
                                </tr>
                            </thead>
                            <tbody id="tiers-body">
                                <!-- Tier rows injected via JS -->
                            </tbody>
                        </table>
                        <button id="save-tiers-btn" onclick="saveExitTiers()" class="brutalist-button btn-green w-full text-xs">
                            保存梯度
                        </button>
                    </div>
                </div>

                <!-- Profit Recycling -->
                <div class="brutalist-card p-6 border-l-4 border-l-[#a855f7]">
                    <h2 class="text-xl font-bold mb-6 flex items-center border-b border-[#333] pb-2">
                        利润循环设置
                    </h2>
                    <form id="profit-form" class="space-y-5">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1.5 tracking-widest">自动定投 QQQM</label>
                            <select name="auto_invest_qqqm" class="brutalist-input appearance-none cursor-pointer">
                                <option value="0">已禁用</option>
                                <option value="1">已启用</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1.5 tracking-widest">起投阈值 ($)</label>
                            <input name="auto_invest_min_threshold" type="number" step="10" placeholder="500" class="brutalist-input">
                        </div>
                        <p class="text-[9px] text-gray-600 font-bold uppercase leading-relaxed italic border-l-2 border-[#333] pl-3 py-1">
                            已实现 LEAPS 利润超过阈值时自动部署到 QQQM 现货持仓。
                        </p>
                        <button id="save-profit-btn" type="submit" class="brutalist-button w-full mt-4" style="border-color: #a855f7; color: #a855f7;">
                            更新循环参数
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // System Clock
        function updateTime() {
            const now = new Date();
            document.getElementById('sys-time').innerText = now.toTimeString().split(' ')[0];
        }
        setInterval(updateTime, 1000);
        updateTime();
    </script>
</body>

</html>
