<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QQQ LEAPS | 交易管理系统 v2.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ========================================
           Apple Design System v2.5 Unified
           所有页面共享的统一样式
        ======================================== */

        /* --- Color System (语义化颜色) --- */
        :root {
            --apple-blue: #0071E3;
            --apple-green: #248A3D;
            --apple-red: #C9342C;
            --apple-orange: #FF9500;
            --apple-purple: #AF52DE;
            --apple-bg: #F5F5F7;
            --apple-text: #1D1D1F;
            --apple-text-secondary: rgba(0, 0, 0, 0.5);
            --apple-text-tertiary: rgba(0, 0, 0, 0.35);
            --apple-border: rgba(0, 0, 0, 0.08);
            --apple-border-focus: rgba(0, 113, 227, 0.25);
        }

        /* --- Typography & Base --- */
        body {
            background-color: var(--apple-bg);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            color: var(--apple-text);
            line-height: 1.5;
            letter-spacing: -0.01em;
        }

        /* 金融数字专用 - 消除数字抖动 */
        .font-numeric {
            font-variant-numeric: tabular-nums;
            font-feature-settings: "tnum" on, "lnum" on;
        }

        /* --- Glassmorphism Components --- */
        .apple-glass {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.4);
        }

        .apple-card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 18px;
            box-shadow:
                0 4px 20px rgba(0, 0, 0, 0.03),
                0 1px 3px rgba(0, 0, 0, 0.04),
                inset 0 0 0 1px rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(0, 0, 0, 0.06);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .apple-card:hover {
            box-shadow:
                0 8px 30px rgba(0, 0, 0, 0.05),
                0 2px 6px rgba(0, 0, 0, 0.04),
                inset 0 0 0 1px rgba(255, 255, 255, 0.5);
        }

        /* --- Form Controls --- */
        .apple-input {
            background: rgba(0, 0, 0, 0.02);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 14px;
            color: var(--apple-text);
            outline: none;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
        }

        .apple-input::placeholder {
            color: var(--apple-text-tertiary);
        }

        .apple-input:hover {
            border-color: rgba(0, 0, 0, 0.15);
        }

        .apple-input:focus {
            border-color: var(--apple-blue);
            background: #fff;
            box-shadow: 0 0 0 4px var(--apple-border-focus);
        }

        /* --- Buttons --- */
        .apple-btn {
            background: var(--apple-blue);
            color: #fff;
            border: none;
            border-radius: 10px;
            font-weight: 500;
            font-size: 14px;
            padding: 10px 20px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .apple-btn:hover {
            background: #0063CC;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .apple-btn:active {
            transform: scale(0.97);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .apple-btn-secondary {
            background: rgba(0, 0, 0, 0.04);
            color: var(--apple-text);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .apple-btn-secondary:hover {
            background: rgba(0, 0, 0, 0.06);
        }

        .apple-btn-success {
            background: var(--apple-green);
        }

        .apple-btn-success:hover {
            background: #1E7A32;
        }

        .apple-btn-danger {
            background: var(--apple-red);
        }

        .apple-btn-danger:hover {
            background: #B02A24;
        }

        /* --- Status Indicators --- */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.8);
        }

        /* --- Mobile Touch Optimizations --- */
        @media (hover: none) and (pointer: coarse) {
            /* 放大所有可交互元素的触控区域 */
            button, .apple-btn, select {
                min-height: 44px;
                min-width: 44px;
            }

            /* 移动端分段删除按钮优化 */
            .tier-row button {
                padding: 8px 16px;
                font-size: 13px;
                background: rgba(239, 68, 68, 0.1);
                border: 1px solid rgba(239, 68, 68, 0.2);
            }

            /* 表格行触控优化 */
            #tiers-body tr {
                cursor: pointer;
            }

            /* 表单元素触控优化 */
            input, select {
                padding: 12px 14px;
                font-size: 16px;
            }
        }

        /* --- PC端表格优化 --- */
        @media (min-width: 769px) {
            .tier-row td {
                padding: 8px 4px !important;
                vertical-align: middle;
            }

            .tier-row .tier-input-group {
                min-width: 180px;
                max-width: 200px;
            }

            .tier-row .tier-pnl-group {
                min-width: 120px;
                max-width: 140px;
            }

            .tier-row input {
                max-width: 70px;
                min-width: 50px;
            }

            .tier-row .tier-max,
            .tier-row .tier-min {
                width: 55px !important;
            }

            .tier-row .tier-pnl {
                width: 65px !important;
            }
        }

        /* --- Focus States for Accessibility --- */
        button:focus-visible,
        input:focus-visible,
        select:focus-visible {
            outline: 2px solid var(--apple-blue);
            outline-offset: 2px;
        }

        /* --- Semantic Colors --- */
        .text-positive {
            color: var(--apple-green);
        }

        .text-negative {
            color: var(--apple-red);
        }

        .text-label {
            color: var(--apple-text-secondary);
        }

        .text-label-light {
            color: var(--apple-text-tertiary);
        }

        /* --- Scrollbar --- */
        .custom-scroll::-webkit-scrollbar {
            width: 5px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.15);
            border-radius: 10px;
        }

        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.25);
        }

        /* --- Number Input Fixes --- */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        /* --- Selection --- */
        ::selection {
            background: rgba(0, 113, 227, 0.2);
        }

        /* --- 分段止盈表格容器优化 --- */
        #tiers-body {
            width: 100%;
            table-layout: fixed;
        }

        .tier-row {
            width: 100%;
        }

        .tier-row td {
            padding: 6px 4px;
            vertical-align: middle;
        }

        .tier-input-group,
        .tier-pnl-group {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* --- Tablet Overrides (中等屏幕优化) --- */
        @media (min-width: 769px) and (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            .stats-grid > div {
                margin-bottom: 8px;
            }

            .lg\:col-span-4 {
                grid-column: span 6;
            }
        }

        /* --- Mobile Overrides (深度优化) --- */
        @media (max-width: 768px) {
            html {
                /* iOS Safari 防止缩放和滚动问题 */
                -webkit-text-size-adjust: 100%;
                overflow-x: hidden;
            }

            body {
                padding-bottom: 40px;
                min-width: 0;
                overflow-x: hidden;
                /* iOS Safari viewport fix */
                width: 100%;
            }

            .apple-card {
                padding: 16px !important;
                border-radius: 12px;
                margin-bottom: 4px;
                min-width: 0;
                overflow: hidden;
            }

            .grid {
                display: grid !important;
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }

            .stats-grid {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 10px !important;
            }

            .stats-grid > div:last-child {
                grid-column: span 2;
            }

            h1 {
                font-size: 1rem !important;
            }

            .stats-val {
                font-size: 1rem !important;
                font-weight: 700;
                /* 关键：防止数字溢出 */
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                min-width: 0;
                max-width: 100%;
            }

            /* 关键修复：将分段策略表格在手机端转换为块状布局，防止挤压 */
            #tiers-body tr {
                display: flex;
                flex-direction: column;
                padding: 12px 0;
                border-bottom: 2px solid var(--apple-bg);
            }

            #tiers-body td {
                display: block;
                width: 100% !important;
                padding: 4px 0 !important;
                text-align: left !important;
                min-width: 0;
                overflow: hidden;
            }

            .tier-input-group {
                justify-content: space-between;
                width: 100%;
            }

            .apple-input {
                width: 100% !important;
                /* 让表单输入框占满宽度 */
                max-width: none !important;
                min-width: 0;
            }

            .tier-row .apple-input {
                width: 45% !important;
                /* 分段天数各占近一半 */
            }

            .tier-pnl-group .apple-input {
                width: 80% !important;
            }

            /* 表格容器溢出处理 - 关键修复 */
            .overflow-x-auto {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch;
                min-width: 100%;
                /* 添加滚动提示 */
                background-image: linear-gradient(90deg, transparent 95%, rgba(0,0,0,0.02));
                background-size: 100% 100%;
                background-repeat: no-repeat;
            }

            .overflow-x-auto table {
                min-width: 600px;
                /* 确保表格不压缩 */
            }

            .overflow-x-auto td,
            .overflow-x-auto th {
                white-space: nowrap;
                min-width: 80px;
                max-width: 150px;
                overflow: hidden;
                text-overflow: ellipsis;
                padding: 12px 8px !important;
            }

            /* 表格滚动条美化 */
            .overflow-x-auto::-webkit-scrollbar {
                height: 4px;
            }

            .overflow-x-auto::-webkit-scrollbar-thumb {
                background: rgba(0, 0, 0, 0.2);
                border-radius: 10px;
            }

            .overflow-x-auto::-webkit-scrollbar-thumb:hover {
                background: rgba(0, 0, 0, 0.3);
            }

            /* 统计卡片数字溢出保护 */
            .apple-card .font-numeric {
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                display: block;
                max-width: 100%;
            }

            /* 导航栏优化 */
            nav.apple-glass {
                padding-left: 12px !important;
                padding-right: 12px !important;
            }

            /* 按钮触控区域优化 */
            .apple-btn {
                min-height: 44px;
                min-width: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            /* 容器宽度限制 */
            .container {
                padding-left: 12px !important;
                padding-right: 12px !important;
            }

            /* 表单元素优化 */
            .space-y-5 > * + * {
                margin-top: 12px !important;
            }

            .space-y-4 > * + * {
                margin-top: 12px !important;
            }

            .space-y-6 > * + * {
                margin-top: 16px !important;
            }

            /* 侧边栏/右侧区域优化 */
            .lg\\:col-span-4 {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .lg\\:col-span-4 > section {
                margin-bottom: 0;
            }

            /* 标签优化 */
            label {
                display: block;
                width: 100%;
            }

            /* 下拉选择框优化 */
            select.apple-input {
                appearance: none;
                -webkit-appearance: none;
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
                background-repeat: no-repeat;
                background-position: right 12px center;
                padding-right: 36px;
            }

            /* 警报日志区域优化 */
            #alerts-container {
                max-height: 200px !important;
            }

            /* iOS Safari 输入框焦点修复 */
            input[type="number"]:focus,
            input[type="text"]:focus,
            select:focus {
                font-size: 16px !important;
                /* 防止iOS自动缩放 */
            }

            /* 触摸设备按钮优化 */
            @media (hover: none) and (pointer: coarse) {
                .apple-btn {
                    min-height: 48px;
                    min-width: 48px;
                }
            }
        }

        /* 更小屏幕的额外优化 */
        @media (max-width: 380px) {
            .stats-grid {
                grid-template-columns: 1fr !important;
            }

            .stats-grid > div:last-child {
                grid-column: span 1;
            }

            .stats-val {
                font-size: 0.9rem !important;
            }

            .apple-card {
                padding: 12px !important;
            }
        }

        /* 修复表格横向滚动提示 */
        .overflow-x-auto {
            -webkit-overflow-scrolling: touch;
        }

        /* --- 横向滚动提示（视觉提示用户可以滚动）--- */
        .scroll-hint {
            position: relative;
        }

        .scroll-hint::after {
            content: '← 滑动查看更多 →';
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
            pointer-events: none;
            opacity: 0;
            animation: fadeInOut 3s ease-in-out;
            z-index: 10;
        }

        @media (max-width: 768px) {
            .scroll-hint::after {
                opacity: 1;
            }
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            20%, 80% { opacity: 1; }
        }
    </style>
    <script>
        let currentMaxHoldDays = 270;
        async function fetchStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                const connDot = document.getElementById('conn-dot');
                const connText = document.getElementById('conn-text');
                const connDotMobile = document.getElementById('conn-dot-mobile');
                const connTextMobile = document.getElementById('conn-text-mobile');

                const statusColor = data.connected ? 'var(--apple-green)' : 'var(--apple-red)';
                const statusText = data.connected ? '终端网络在线' : '终端网络断开';

                if (connDot) connDot.style.backgroundColor = statusColor;
                if (connText) { connText.innerText = statusText; connText.style.color = statusColor; }
                if (connDotMobile) connDotMobile.style.backgroundColor = statusColor;
                if (connTextMobile) { connTextMobile.innerText = statusText; connTextMobile.style.color = statusColor; }

                const tbody = document.getElementById('pos-body');
                tbody.innerHTML = '';
                if (!data.positions || data.positions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-gray-400 italic">暂无活跃持仓</td></tr>';
                } else {
                    data.positions.forEach(pos => {
                        const tr = document.createElement('tr');
                        tr.className = "border-b border-gray-50 hover:bg-gray-30 transition-colors";
                        tr.innerHTML = `
                            <td class="p-4 font-semibold text-blue-600">${pos.symbol}</td>
                            <td class="p-4 text-label-light text-xs font-numeric">${pos.contract_id}</td>
                            <td class="p-4 text-label text-xs">${pos.entry_date}</td>
                            <td class="p-4 font-medium font-numeric">$${pos.entry_price.toFixed(2)}</td>
                            <td class="p-4 font-numeric">${pos.quantity}</td>
                            <td class="p-4 text-label">--</td>
                            <td class="p-4"><span class="bg-blue-50 text-blue-600 px-2 py-1 rounded-full text-[10px] font-bold">运行中</span></td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
                if (data.settings && data.settings.entry_drop_pct !== undefined && !document.forms['buy-form'].dataset.filled) {
                    const bf = document.forms['buy-form'];
                    bf.entry_drop_pct.value = (data.settings.entry_drop_pct * 100).toFixed(2);
                    bf.roll_drop_pct.value = (data.settings.roll_drop_pct * 100).toFixed(2);
                    bf.target_delta.value = data.settings.target_delta;
                    bf.delta_tolerance.value = data.settings.delta_tolerance;
                    bf.max_option_spread.value = (data.settings.max_option_spread * 100).toFixed(0);
                    bf.min_expiry_days.value = data.settings.min_expiry_days;
                    bf.max_positions.value = data.settings.max_positions;
                    bf.order_quantity.value = data.settings.order_quantity || 1;
                    bf.dataset.filled = "true";
                }
                if (data.settings && data.settings.auto_invest_min_threshold !== undefined && !document.forms['profit-form'].dataset.filled) {
                    const pf = document.forms['profit-form'];
                    pf.auto_invest_qqqm.value = data.settings.auto_invest_qqqm;
                    pf.auto_invest_min_threshold.value = data.settings.auto_invest_min_threshold;
                    pf.dataset.filled = "true";
                }
                if (data.stats) {
                    const profit = data.stats.leaps_realized_profit || 0;
                    const invested = data.stats.qqqm_invested_capital || 0;
                    document.getElementById('profit-pool').innerText = `$${(profit - invested).toLocaleString('zh-CN', { minimumFractionDigits: 2 })}`;
                    document.getElementById('invested-info').innerText = `已投: $${invested.toLocaleString()} / 总计: $${profit.toLocaleString()}`;
                }
                if (data.portfolio && data.portfolio.summary) {
                    const sum = data.portfolio.summary;
                    const netLiqE = document.getElementById('net-liq');
                    const cashE = document.getElementById('cash-balance');
                    const bpE = document.getElementById('buying-power');
                    if (netLiqE) netLiqE.innerText = '$' + sum.NetLiquidity.toLocaleString(undefined, { minimumFractionDigits: 2 });
                    if (cashE) cashE.innerText = '$' + sum.TotalCashValue.toLocaleString(undefined, { minimumFractionDigits: 2 });
                    if (bpE) bpE.innerText = '$' + sum.BuyingPower.toLocaleString(undefined, { minimumFractionDigits: 2 });
                }
                const pbody = document.getElementById('portfolio-body');
                if (pbody && data.portfolio && data.portfolio.holdings) {
                    pbody.innerHTML = '';
                    data.portfolio.holdings.forEach(h => {
                        const tr = document.createElement('tr');
                        tr.className = "text-[12px] border-b border-gray-50 hover:bg-gray-30 transition-colors";
                        const pnlColor = h.unrealizedPnL >= 0 ? 'text-positive' : 'text-negative';
                        tr.innerHTML = `
                            <td class="p-3 font-medium">${h.symbol}</td>
                            <td class="p-3 text-label-light uppercase text-[10px]">${h.secType}</td>
                            <td class="p-3">${h.quantity}</td>
                            <td class="p-3 text-label">$${h.mktPrice.toFixed(2)}</td>
                            <td class="p-3 font-bold font-numeric ${pnlColor}">$${h.unrealizedPnL.toFixed(2)}</td>
                            <td class="p-3 text-right font-numeric">$${h.mktValue.toLocaleString()}</td>
                        `;
                        pbody.appendChild(tr);
                    });
                }
                if (data.settings && data.settings.time_exit_days !== undefined && !document.forms['sell-form'].dataset.filled) {
                    const sf = document.forms['sell-form'];
                    sf.time_exit_days.value = data.settings.time_exit_days;
                    currentMaxHoldDays = data.settings.time_exit_days;
                    updateExitTiersDisplay();
                    sf.dataset.filled = "true";
                }
            } catch (e) { console.error(e); }
        }
        async function fetchExitTiers() {
            try {
                const res = await fetch('/api/exit_tiers');
                const data = await res.json();
                renderTiers(data.tiers);
            } catch (e) { console.error(e); }
        }
        function renderTiers(tiers) {
            const tbody = document.getElementById('tiers-body');
            tbody.innerHTML = '';
            tiers.forEach((tier, idx) => {
                const isLast = idx === tiers.length - 1;
                const container = document.createElement('div');
                container.className = "apple-card rounded-lg p-4 shadow-md bg-gray-50 mb-3";
                container.innerHTML = `
<span class=""> Adjust segments }
</span>

``
                            <span class="text-[10px] sm:hidden font-bold text-label mr-2">持有天数:</span>
                            <div class="flex items-center space-x-1 flex-1">
                                <input type="number" class="tier-min apple-input text-center px-1 font-numeric" value="${tier.days_min}">
                                <span class="text-gray-300">-</span>
                                <input type="number" class="tier-max apple-input text-center px-1 font-numeric"
                                       value="${isLast ? currentMaxHoldDays : tier.days_max}" ${isLast ? 'disabled' : ''}>
                            </div>
                        </div>
                    </td>
                    <td class="py-2">
                        <div class="flex items-center tier-pnl-group">
                            <span class="text-[10px] sm:hidden font-bold text-label mr-2">目标盈亏:</span>
                            <div class="flex items-center space-x-1 flex-1">
                                <input type="number" class="tier-pnl apple-input text-center px-1 font-bold text-positive font-numeric" value="${(tier.target_pnl * 100).toFixed(0)}">
                                <span class="text-[10px] text-label-light font-bold">%</span>
                            </div>
                        </div>
                    </td>
                    <td class="py-2 text-right">
                        <button onclick="removeTierRow(this)" class="bg-red-50 text-red-500 rounded-lg px-4 py-1.5 text-xs font-bold sm:bg-transparent sm:p-0 sm:text-lg">删除分段</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            updateExitTiersDisplay();
        }
        function addTierRow() {
            const tbody = document.getElementById('tiers-body');
            const containers = tbody.querySelectorAll('.apple-card');
            let lastMax = 0;
            if (containers.length > 0) {
                const prevLastMax = containers[containers.length - 1].querySelector('#tier-max');
                prevLastMax.disabled = false;
                lastMax = parseInt(prevLastMax.value) || 0;
            }
            const tr = document.createElement('tr');
            tr.className = "tier-row border-b border-gray-50";
            tr.innerHTML = `
                <td class="py-2">
                    <div class="flex items-center tier-input-group">
                        <span class="text-[10px] sm:hidden font-bold text-label mr-2">持有天数:</span>
                        <div class="flex items-center space-x-1 flex-1">
                            <input type="number" class="tier-min apple-input text-center px-1 font-numeric" value="${lastMax + 1}"><span class="text-gray-300">-</span><input type="number" class="tier-max apple-input text-center px-1 font-numeric" value="${currentMaxHoldDays}" disabled>
                        </div>
                    </div>
                </td>
                <td class="py-2">
                    <div class="flex items-center tier-pnl-group">
                        <span class="text-[10px] sm:hidden font-bold text-label mr-2">目标盈亏:</span>
                        <div class="flex items-center space-x-1 flex-1">
                            <input type="number" class="tier-pnl apple-input text-center px-1 font-bold text-positive font-numeric" value="10"><span class="text-[10px] text-label-light font-bold">%</span>
                        </div>
                    </div>
                </td>
                <td class="py-2 text-right">
                    <button onclick="removeTierRow(this)" class="bg-red-50 text-red-500 rounded-lg px-4 py-1.5 text-xs font-bold sm:bg-transparent sm:p-0 sm:text-lg">删除分段</button>
                </td>
            `;
            tbody.appendChild(tr);
            updateExitTiersDisplay();
        }
        function removeTierRow(btn) {
            btn.closest('.apple-card').remove();
            const cards = document.querySelectorAll('.apple-card');
            if (cards.length > 0) {
                const lastIdx = cards.length - 1;
                const lastMax = cards[lastIdx].querySelector('#tier-max');
                lastMax.value = currentMaxHoldDays;
                lastMax.disabled = true;
            }
        }
        function updateExitTiersDisplay() {
            const cards = document.querySelectorAll('.apple-card');
            cards.forEach((card, idx) => {
                const minInput = card.querySelector('#tier-min');
                const maxInput = card.querySelector('#tier-max');
                const min = parseInt(minInput.value);
                const isLast = idx === cards.length - 1;

                if (isLast) {
                    maxInput.value = currentMaxHoldDays;
                    maxInput.disabled = true;
                }

                if (min >= currentMaxHoldDays) {
                    card.classList.add('opacity-30', 'grayscale');
                    card.title = "时间越限";
                } else {
                    card.classList.remove('opacity-30', 'grayscale');
                    card.title = "";
                }
            });
        }
        async function saveExitTiers() {
            const cards = document.querySelectorAll('.apple-card');
            const tiers = [];
            cards.forEach(card => {
                const min = parseInt(card.querySelector('#tier-min').value);
                const maxField = card.querySelector('#tier-max');
                const max = maxField.disabled ? currentMaxHoldDays : parseInt(maxField.value);
                const pnl = parseFloat(card.querySelector('#tier-target-pnl').value) / 100;

                if (min < currentMaxHoldDays) {
                    tiers.push({ days_min: min, days_max: max, target_pnl: pnl });
                }
            });

            const btn = document.getElementById('save-tiers-btn');
            const originalText = '应用分段策略'; 
            btn.innerText = '同步中...';

            try {
                const res = await fetch('/api/exit_tiers', {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ tiers }) 
                });

                btn.innerText = res.ok ? '已部署' : '失败';
            } catch (e) {
                console.error(e);
                btn.innerText = '保存失败';
            }

            setTimeout(() => btn.innerText = originalText, 2000);
}
        async function fetchAlerts() {
            try {
                const res = await fetch('/api/alerts');
                const data = await res.json();
                const container = document.getElementById('alerts-container');
                if (!data.alerts || data.alerts.length === 0) {
                    container.innerHTML = '<div class="text-label-light text-center py-4 text-xs">暂无活跃系统警报</div>';
                    return;
                }
                container.innerHTML = '';
                data.alerts.forEach(alert => {
                    const div = document.createElement('div');
                    const colorClasses = alert.level === 'ERROR' ? 'text-negative bg-red-50' : (alert.level === 'WARN' ? 'text-orange-500 bg-orange-50' : 'text-blue-500 bg-blue-50');
                    const timeStr = alert.timestamp.includes(' ') ? alert.timestamp.split(' ')[1] : (alert.timestamp.includes('T') ? alert.timestamp.split('T')[1].split('.')[0] : alert.timestamp);
                    div.className = `p-3 mb-2 rounded-xl border border-gray-100 flex items-start space-x-3`;
                    div.innerHTML = `<span class="text-[10px] text-label-light shrink-0 mt-0.5 font-numeric">${timeStr}</span> 
                                     <div class="flex-1 text-xs">
                                         <span class="font-bold px-1.5 py-0.5 rounded text-[9px] mr-1 uppercase ${colorClasses}">${alert.level}</span>
                                         <span class="text-label leading-relaxed">${alert.message}</span>
                                     </div>`;
                    container.appendChild(div);
                });
            } catch (e) {
                console.error(e);
                document.getElementById('alerts-container').innerHTML = '<div class="text-negative text-center py-4 text-xs font-medium">通讯链路异常: 无法连接后端数据节点</div>';
            }
        }
        async function handleFormSubmit(e, btnId, originalText) {
            e.preventDefault();
            const btn = document.getElementById(btnId);
            btn.innerText = '保存中...';
            const form = new FormData(e.target);
            let data = Object.fromEntries(form.entries());

            // 数值类型显式转换，确保后端持久化类型正确
            if (data.entry_drop_pct !== undefined) data.entry_drop_pct = parseFloat(data.entry_drop_pct) / 100;
            if (data.roll_drop_pct !== undefined) data.roll_drop_pct = parseFloat(data.roll_drop_pct) / 100;
            if (data.target_delta !== undefined) data.target_delta = parseFloat(data.target_delta);
            if (data.delta_tolerance !== undefined) data.delta_tolerance = parseFloat(data.delta_tolerance);
            if (data.max_option_spread !== undefined) data.max_option_spread = parseFloat(data.max_option_spread) / 100;
            if (data.min_expiry_days !== undefined) data.min_expiry_days = parseInt(data.min_expiry_days);
            if (data.max_positions !== undefined) data.max_positions = parseInt(data.max_positions);
            if (data.order_quantity !== undefined) data.order_quantity = parseInt(data.order_quantity);
            if (data.time_exit_days !== undefined) {
                data.time_exit_days = parseInt(data.time_exit_days);
                currentMaxHoldDays = data.time_exit_days;
            }
            if (data.auto_invest_min_threshold !== undefined) data.auto_invest_min_threshold = parseFloat(data.auto_invest_min_threshold);
            if (data.auto_invest_qqqm !== undefined) data.auto_invest_qqqm = parseInt(data.auto_invest_qqqm);

            try {
                const res = await fetch('/api/settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                btn.innerText = res.ok ? '已保存' : '错误';
                if (res.ok && btnId === 'save-sell-btn') updateExitTiersDisplay();
            } catch { btn.innerText = '异常'; }
            setTimeout(() => btn.innerText = originalText, 2000);
        }
        setInterval(fetchStatus, 3000);
        setInterval(fetchAlerts, 5000);
        window.onload = function () {
            fetchStatus(); fetchExitTiers(); fetchAlerts();
            document.getElementById('buy-form').onsubmit = (e) => handleFormSubmit(e, 'save-buy-btn', '同步配置协议');
            document.getElementById('sell-form').onsubmit = (e) => handleFormSubmit(e, 'save-sell-btn', '更新卖出逻辑');
            document.getElementById('profit-form').onsubmit = (e) => handleFormSubmit(e, 'save-profit-btn', '同步循环参数');
            document.forms['sell-form'].time_exit_days.addEventListener('input', (e) => {
                currentMaxHoldDays = parseInt(e.target.value) || 0;
                updateExitTiersDisplay();
            });
            setInterval(() => {
                const now = new Date().toTimeString().split(' ')[0];
                const sysTime = document.getElementById('sys-time');
                const sysTimeMobile = document.getElementById('sys-time-mobile');
                if (sysTime) sysTime.innerText = now;
                if (sysTimeMobile) sysTimeMobile.innerText = now;
            }, 1000);
        };
    </script>
</head>

<body class="pb-20">
    <nav class="apple-glass sticky top-0 z-50 px-4 md:px-6 py-3 flex justify-between items-center shadow-sm">
        <div class="flex items-center space-x-3">
            <h1 class="text-base md:text-lg font-bold tracking-tight text-gray-900 leading-tight">QQQ LEAPS <br
                    class="xs:hidden"> <span class="text-blue-600">管理后台</span></h1>
            <div class="hidden sm:flex items-center space-x-2 bg-gray-100 rounded-full px-3 py-1">
                <span id="conn-dot" class="status-dot bg-gray-300"></span>
                <span id="conn-text" class="text-[10px] font-semibold text-gray-500 uppercase">检测中</span>
            </div>
        </div>
        <div class="flex items-center space-x-3 md:space-x-6">
            <div class="hidden md:block text-[12px] text-label">
                系统时间: <span id="sys-time" class="font-medium text-gray-600 font-numeric">00:00:00</span>
            </div>
            <form action="/logout" method="POST" class="m-0">
                <button
                    class="bg-white border border-gray-200 px-3 md:px-5 py-1.5 rounded-full hover:bg-gray-50 transition-colors font-medium text-[12px] text-gray-600 shadow-sm">退出</button>
            </form>
        </div>
    </nav>
    <div class="sm:hidden bg-white/50 border-b border-gray-100 px-4 py-2 flex justify-between items-center">
        <div class="flex items-center space-x-2">
            <span id="conn-dot-mobile" class="status-dot bg-gray-300 w-2 h-2"></span>
            <span id="conn-text-mobile" class="text-[10px] font-semibold text-gray-500 uppercase">检测中</span>
        </div>
        <div class="text-[10px] text-label">
            <span id="sys-time-mobile" class="font-numeric">00:00:00</span>
        </div>
    </div>

    <main class="container mx-auto px-4 md:px-6 mt-6 md:mt-10 space-y-6 md:space-y-8">
        <div class="stats-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="apple-card p-4">
                <div class="text-[10px] font-bold text-label-light uppercase tracking-wider mb-1">资产净值</div>
                <div id="net-liq" class="stats-val text-xl font-bold text-gray-900 font-numeric">$0.00</div>
            </div>
            <div class="apple-card p-4">
                <div class="text-[10px] font-bold text-label-light uppercase tracking-wider mb-1">可用现金</div>
                <div id="cash-balance" class="stats-val text-xl font-bold text-positive font-numeric">$0.00</div>
            </div>
            <div class="apple-card p-4">
                <div class="text-[10px] font-bold text-label-light uppercase tracking-wider mb-1">当前购买力</div>
                <div id="buying-power" class="stats-val text-xl font-bold text-orange-500 font-numeric">$0.00</div>
            </div>
            <div class="apple-card p-4 border-l-4 border-purple-400">
                <div class="text-[10px] font-bold text-label-light uppercase tracking-wider mb-1">已实现利润 (再投资)</div>
                <div id="profit-pool" class="stats-val text-xl font-bold text-gray-900 font-numeric">$0.00</div>
                <div id="invested-info" class="text-[10px] text-label-light mt-1">系统就绪</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-8 space-y-8">
                <section class="apple-card overflow-hidden">
                    <div
                        class="px-4 md:px-6 py-4 bg-gray-50/50 border-b border-gray-100 flex justify-between items-center">
                        <h2 class="font-bold text-sm text-gray-800">LEAPS 期权核心持仓</h2>
                        <span class="text-[10px] uppercase font-bold text-gray-400">实时更新中</span>
                    </div>
                    <div class="overflow-x-auto scroll-hint">
                        <table class="w-full text-left text-sm apple-table">
                            <thead class="bg-gray-50/30 text-[10px] font-bold text-label uppercase tracking-wider">
                                <tr>
                                    <th class="px-4 md:px-6 py-4">代码</th>
                                    <th class="px-4 md:px-6 py-4 text-xs font-normal">合约ID</th>
                                    <th class="px-4 md:px-6 py-4">买入日期</th>
                                    <th class="px-4 md:px-6 py-4">开仓价</th>
                                    <th class="px-4 md:px-6 py-4">数量</th>
                                    <th class="px-4 md:px-6 py-4">未结盈亏</th>
                                    <th class="px-4 md:px-6 py-4 text-right">状态</th>
                                </tr>
                            </thead>
                            <tbody id="pos-body"></tbody>
                        </table>
                    </div>
                </section>

                <section class="apple-card overflow-hidden">
                    <div class="px-4 md:px-6 py-4 bg-gray-50/50 border-b border-gray-100">
                        <h2 class="font-bold text-sm text-gray-800">账户综合资产报告</h2>
                    </div>
                    <div class="overflow-x-auto custom-scroll scroll-hint" style="max-height: 400px;">
                        <table class="w-full text-left text-sm apple-table">
                            <thead
                                class="bg-gray-50/30 text-[10px] font-bold text-label uppercase tracking-wider sticky top-0 backdrop-blur-md">
                                <tr>
                                    <th class="px-4 md:px-6 py-4">资产名</th>
                                    <th class="px-4 md:px-6 py-4">类型</th>
                                    <th class="px-4 md:px-6 py-4">持仓量</th>
                                    <th class="px-4 md:px-6 py-4">市价</th>
                                    <th class="px-4 md:px-6 py-4">盈亏</th>
                                    <th class="px-4 md:px-6 py-4 text-right">总市值</th>
                                </tr>
                            </thead>
                            <tbody id="portfolio-body"></tbody>
                        </table>
                    </div>
                </section>
            </div>

            <div class="lg:col-span-4 space-y-8">
                <section class="apple-card p-4 md:p-6 space-y-6">
                    <h3 class="font-bold text-sm border-b border-gray-100 pb-4 text-gray-900">策略入场与转仓设置</h3>
                    <form id="buy-form" class="space-y-5">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-[10px] font-bold text-label uppercase block mb-1.5">入场跌幅
                                    %</label><input name="entry_drop_pct" type="number" step="0.1"
                                    class="apple-input w-full font-numeric"></div>
                            <div><label class="text-[10px] font-bold text-label uppercase block mb-1.5">ROLL 跌幅
                                    %</label><input name="roll_drop_pct" type="number" step="0.1"
                                    class="apple-input w-full font-numeric"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-[10px] font-bold text-label uppercase block mb-1.5">目标
                                    Delta</label><input name="target_delta" type="number" step="0.01"
                                    class="apple-input w-full font-numeric"></div>
                            <div><label class="text-[10px] font-bold text-label uppercase block mb-1.5">Delta
                                    容错</label><input name="delta_tolerance" type="number" step="0.01"
                                    class="apple-input w-full font-numeric"></div>
                        </div>
                        <div><label class="text-[10px] font-bold text-label uppercase block mb-1.5">最大点差 %
                                (流动性)</label><input name="max_option_spread" type="number" step="1"
                                class="apple-input w-full font-numeric"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label
                                    class="text-[10px] font-bold text-label uppercase block mb-1.5">最小到期天数</label><input
                                    name="min_expiry_days" type="number" class="apple-input w-full font-numeric"></div>
                            <div><label
                                    class="text-[10px] font-bold text-label uppercase block mb-1.5">最大持仓笔数</label><input
                                    name="max_positions" type="number" class="apple-input w-full font-numeric"></div>
                        </div>
                        <div><label class="text-[10px] font-bold text-label uppercase block mb-1.5">单次下单数量</label><input
                                name="order_quantity" type="number" class="apple-input w-full font-numeric"></div>
                        <button id="save-buy-btn" class="apple-btn w-full py-3">同步配置协议</button>
                    </form>
                </section>

                <section class="apple-card p-4 md:p-6 space-y-6">
                    <h3 class="font-bold text-sm border-b border-gray-100 pb-4 text-gray-900">止盈与风险管理设置</h3>
                    <form id="sell-form" class="space-y-4">
                        <div><label class="text-[10px] font-bold text-label uppercase block mb-1.5">强制平仓天数</label><input
                                name="time_exit_days" type="number" class="apple-input w-full font-numeric"></div>
                        <button id="save-sell-btn" class="apple-btn w-full apple-btn-danger">更新设置</button>
                    </form>
                    <div class="pt-4 border-t border-gray-100">
                        <div class="flex items-center justify-between">
                            <h4 class="text-sm font-bold text-gray-800">分段止盈策略</h4>
                            <button onclick="addTierRow()" class="text-blue-500 text-xs font-semibold hover:underline">+ 添加分段</button>
                        </div>
                        <div class="space-y-4 mt-4">
                            <div class="apple-card rounded-lg p-4 shadow-md bg-gray-50">
                                <div class="flex items-center justify-between">
                                    <div class="flex flex-col">
                                        <span class="text-gray-700 text-xs">持有天数：</span>
                                        <div class="flex items-center mt-2">
                                            <input id="tier-min" class="apple-input w-16 h-8 px-2 text-xs font-numeric" type="number" placeholder="最小天数">
                                            <span class="mx-2">-</span>
                                            <input id="tier-max" class="apple-input w-16 h-8 px-2 text-xs font-numeric" type="number" placeholder="最大天数">
                                        </div>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-gray-700 text-xs">目标盈亏 (%):</span>
                                        <div class="mt-2">
                                            <input id="tier-target-pnl" class="apple-input w-16 h-8 px-2 text-xs font-numeric" type="number" placeholder="10">
                                        </div>
                                    </div>
                                    <button onclick="removeTierRow(this)" class="apple-btn-danger text-white text-xs px-2 py-1.5 rounded-md">删除</button>
                                </div>
                            </div>
                        </div>
                        <button id="save-tiers-btn" onclick="saveExitTiers()"
                            class="apple-btn w-full mt-4 text-sm font-bold bg-green-500 hover:bg-green-600">保存策略</button>
                        <p class="text-center text-xs text-label-light mt-2">新增或修改分段时，通过保存来完成设置更新。</p>
                    </div>
                </section>

                <section class="apple-card p-4 md:p-6 space-y-4">
                    <h3 class="font-bold text-sm border-b border-gray-100 pb-4 text-gray-900">利润再投资设置</h3>
                    <form id="profit-form" class="space-y-4">
                        <div><label class="text-[10px] font-bold text-label uppercase block mb-1.5">自动再投资
                                QQQM</label>
                            <select name="auto_invest_qqqm" class="apple-input w-full appearance-none bg-white">
                                <option value="0">已禁用</option>
                                <option value="1">已开启</option>
                            </select>
                        </div>
                        <div><label class="text-[10px] font-bold text-label uppercase block mb-1.5">再投资金额阈值
                                ($)</label><input name="auto_invest_min_threshold" type="number"
                                class="apple-input w-full shadow-inner font-numeric"></div>
                        <button id="save-profit-btn" class="apple-btn w-full apple-btn-secondary"
                            style="background: var(--apple-purple); color: white;">保存投资参数</button>
                    </form>
                </section>

                <section class="apple-card p-4 md:p-6">
                    <h3 class="font-bold text-sm text-label uppercase tracking-widest mb-6">系统运行日志</h3>
                    <div id="alerts-container" class="max-h-[300px] overflow-y-auto custom-scroll pr-2">
                        <div class="text-label-light italic text-center text-xs py-4">正在建立通讯链接...</div>
                    </div>
                </section>
            </div>
        </div>
    </main>
</body>

</html>
